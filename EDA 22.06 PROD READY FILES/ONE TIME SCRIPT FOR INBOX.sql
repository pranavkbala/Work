-- Databricks notebook source
CREATE TABLE PROD_EDAP_ANALYTICS_DB.PROD_EDAP_ANALYTICS_TABLES.CARE_CENTER_ASSOC_INBOX_BCKUP_DROPBY0522
CLONE
PROD_EDAP_ANALYTICS_DB.PROD_EDAP_ANALYTICS_TABLES.CARE_CENTER_ASSOC_INBOX

CREATE TABLE PROD_EDAP_L1_DB.PROD_EDAP_L1_TABLES.STERLING_CUST_CARE_CC_ASSOC_INBOX_TABLE_ARCHIVE_BCKUP_DROPBY0522
CLONE
PROD_EDAP_L1_DB.PROD_EDAP_L1_TABLES.STERLING_CUST_CARE_CC_ASSOC_INBOX_TABLE_ARCHIVE

-- COMMAND ----------

create  TABLE DEV_EDAP_STAGE_DB.DEV_EDAP_TDM_STAGE_TABLES.INBOX_HISTORY_MAIN_STAGE_FOR_PROD  (
	CARE_CENTER_ASSOC_INBOX_KEY NUMBER(38,0) NOT NULL,
	CARE_CENTER_QUEUE_KEY NUMBER(38,0) NOT NULL,
	INBOX_ID VARCHAR(16777216) NOT NULL,
	INBOX_TYPE_CD VARCHAR(16777216) NOT NULL,
	PARENT_INBOX_ID VARCHAR(16777216) NOT NULL,
	ORDER_HEADER_KEY NUMBER(38,0) NOT NULL,
	ORDER_HEADER_ID VARCHAR(16777216),
	ORDER_LINE_KEY NUMBER(38,0),
	ORDER_LINE_ID VARCHAR(16777216) NOT NULL,
	ORDER_ID VARCHAR(16777216) NOT NULL,
	SUPPLIER_KEY NUMBER(38,0) NOT NULL,
	SUPPLIER_ID VARCHAR(16777216),
	SHIPMENT_KEY NUMBER(38,0) NOT NULL,
	SHIPMENT_ID VARCHAR(16777216),
	SHIPMENT_NBR VARCHAR(16777216),
	CNT_REQUEST_ID VARCHAR(16777216) NOT NULL,
	ENTERPRISE_CD VARCHAR(16777216) NOT NULL,
	WORK_ORDER_KEY NUMBER(38,0),
	WORK_ORDER_ID VARCHAR(16777216) NOT NULL,
	WORK_ORDER_NBR VARCHAR(16777216),
	LOCATION_KEY NUMBER(38,0),
	LOCATION_ID VARCHAR(16777216) NOT NULL,
	WAVE_KEY NUMBER(38,0) NOT NULL,
	WAVE_ID VARCHAR(16777216) NOT NULL,
	WAVE_NBR VARCHAR(16777216),
	MOVE_REQUEST_ID VARCHAR(16777216) NOT NULL,
	SHIPNODE_KEY NUMBER(38,0) NOT NULL,
	SHIPNODE_ID VARCHAR(16777216) NOT NULL,
	ITEM_KEY NUMBER(38,0),
	ITEM_ID VARCHAR(16777216) NOT NULL,
	QUEUE_ID VARCHAR(16777216),
	FIRST_EFFECTIVE_TS TIMESTAMP_NTZ(9) NOT NULL,
	LAST_EFFECTIVE_TS TIMESTAMP_NTZ(9) NOT NULL,
	DESCRIPTION VARCHAR(16777216) NOT NULL,
	DETAIL_DESC VARCHAR(16777216) NOT NULL,
	LIST_DESC VARCHAR(16777216) NOT NULL,
	GENERATED_TS TIMESTAMP_NTZ(9) NOT NULL,
	RESOLUTION_TS VARCHAR(16777216) NOT NULL,
	RESOLVE_BY_TS TIMESTAMP_NTZ(9) NOT NULL,
	LAST_UNASSIGN_ALERT_TS TIMESTAMP_NTZ(9) NOT NULL,
	LAST_UNRESOLVE_ALERT_TS TIMESTAMP_NTZ(9) NOT NULL,
	CLOSED_ON_TS TIMESTAMP_NTZ(9) NOT NULL,
	FOLLOWUP_TS VARCHAR(16777216) NOT NULL,
	LAST_EXCEED_ALERT_TS TIMESTAMP_NTZ(9) NOT NULL,
	LAST_OCCURRED_ON_TS TIMESTAMP_NTZ(9) NOT NULL,
	EXCEPTION_TYPE_CD VARCHAR(16777216) NOT NULL,
	PRIORITY_NBR NUMBER(38,0) NOT NULL,
	STATUS VARCHAR(16777216) NOT NULL,
	LOCKED_FLAG VARCHAR(1) NOT NULL,
	LOCKED_ON_TS TIMESTAMP_NTZ(9) NOT NULL,
	ACTIVE_FLAG VARCHAR(1) NOT NULL,
	EXCEPTION_ESCALATED_FLAG VARCHAR(1) NOT NULL,
	CONSOLIDATION_CNT NUMBER(38,0) NOT NULL,
	FLOW_NAME VARCHAR(16777216) NOT NULL,
	API_NAME VARCHAR(16777216) NOT NULL,
	SUB_FLOW_NAME VARCHAR(16777216) NOT NULL,
	VIEW_ID VARCHAR(16777216) NOT NULL,
	ERROR_REASON VARCHAR(16777216) NOT NULL,
	ERROR_TYPE_CD VARCHAR(16777216) NOT NULL,
	EXPIRATION_DAYS_NBR NUMBER(38,0) NOT NULL,
	INBOX_ADDNL_DATA VARCHAR(16777216),
	LOAD_ID VARCHAR(16777216) NOT NULL,
	CNT_PROGRAM_NAME VARCHAR(16777216) NOT NULL,
	RESOLVED_BY_USER_ID VARCHAR(16777216) NOT NULL,
	BILL_TO_ID VARCHAR(16777216),
	TEAM_CD VARCHAR(16777216),
	UNRESOLVE_REALERT_CNT NUMBER(38,0),
	UNASSIGN_REALERT_CNT NUMBER(38,0),
	INCIDIENT_TYPE_CD VARCHAR(16777216),
	CLAIMABLE_IND VARCHAR(1),
	AUTO_RESOLVED_FLAG VARCHAR(1) NOT NULL,
	OWNER_ID VARCHAR(16777216) NOT NULL,
	OWNER_TYPE_CD VARCHAR(16777216) NOT NULL,
	ASSIGNED_TO_USER_ID VARCHAR(16777216) NOT NULL,
	LOCKED_BY_USER_ID VARCHAR(16777216) NOT NULL,
	CREATE_TS TIMESTAMP_NTZ(9) NOT NULL,
	CREATE_USER_ID VARCHAR(16777216) NOT NULL,
	MODIFY_USER_ID VARCHAR(16777216) NOT NULL,
	MODIFY_TS TIMESTAMP_NTZ(9),
	CREATE_PROG_ID VARCHAR(16777216) NOT NULL,
	MODIFY_PROG_ID VARCHAR(16777216) NOT NULL
);

-- COMMAND ----------

insert into  DEV_EDAP_STAGE_DB.DEV_EDAP_TDM_STAGE_TABLES.INBOX_HISTORY_MAIN_STAGE_FOR_PROD 
SELECT    
	CASE 	
		WHEN STG1.CARE_CENTER_ASSOC_INBOX_KEY = 0 THEN 
			DENSE_RANK() OVER (ORDER BY STG1.CARE_CENTER_ASSOC_INBOX_KEY,STG1.INBOX_ID ) + COALESCE(MAX_CARE_CENTER_ASSOC_INBOX_KEY,0)
		ELSE
			STG1.CARE_CENTER_ASSOC_INBOX_KEY
	END AS CARE_CENTER_ASSOC_INBOX_KEY,	
	COALESCE(QUEUE.CARE_CENTER_QUEUE_KEY,-1) AS CARE_CENTER_QUEUE_KEY ,
	STG1.INBOX_ID  ,
	STG1.INBOX_TYPE_CD  ,
	STG1.PARENT_INBOX_ID  ,
	COALESCE(ORDER_HEADER.ORDER_HEADER_KEY,-1) AS ORDER_HEADER_KEY,
	STG1.ORDER_HEADER_ID ,
	COALESCE(ORDER_LINE.ORDER_LINE_KEY,-1) AS ORDER_LINE_KEY,
	STG1.ORDER_LINE_ID  ,
	STG1.ORDER_ID  AS ORDER_ID,
	COALESCE(VENDOR.VENDOR_KEY,-1) AS SUPPLIER_KEY,
	STG1.SUPPLIER_ID ,
	COALESCE(SHIPMENT.SHIPMENT_KEY,-1) AS SHIPMENT_KEY,
	STG1.SHIPMENT_ID ,
	STG1.SHIPMENT_NBR ,
	STG1.CNT_REQUEST_ID  ,
	STG1.ENTERPRISE_CD  ,
	COALESCE(WORK_ORDER.WORK_ORDER_KEY,-1) AS WORK_ORDER_KEY,
	STG1.WORK_ORDER_ID AS WORK_ORDER_ID,
	STG1.WORK_ORDER_NBR ,
	COALESCE(LOC.LOCATION_KEY,-1) AS LOCATION_KEY,
	STG1.LOCATION_ID  ,
	-1 AS WAVE_KEY,
	STG1.WAVE_ID  ,
	STG1.WAVE_NBR ,
	STG1.MOVE_REQUEST_ID  ,
	COALESCE(SHIPNODE.SHIP_NODE_KEY,-1) AS SHIPNODE_KEY,
	STG1.SHIPNODE_ID  ,
	COALESCE(ITEM.ITEM_KEY,-1) AS ITEM_KEY,
	STG1.ITEM_ID  ,
	STG1.QUEUE_ID ,
	STG1.FIRST_EFFECTIVE_TS  ,
	STG1.LAST_EFFECTIVE_TS  ,
	STG1.DESCRIPTION  ,
	STG1.DETAIL_DESC  ,
	STG1.LIST_DESC  ,
	STG1.GENERATED_TS  ,
    CASE WHEN STG1.RESOLUTION_TS = '' THEN '1900-01-01 00:00:00.000' ELSE STG1.RESOLUTION_TS END AS RESOLUTION_TS,
	STG1.RESOLVE_BY_TS  ,
	STG1.LAST_UNASSIGN_ALERT_TS  ,
	STG1.LAST_UNRESOLVE_ALERT_TS  ,
	STG1.CLOSED_ON_TS  ,
    CASE WHEN STG1.FOLLOWUP_TS = '' THEN '1900-01-01 00:00:00.000' ELSE STG1.FOLLOWUP_TS END AS FOLLOWUP_TS,
	STG1.LAST_EXCEED_ALERT_TS  ,
	STG1.LAST_OCCURRED_ON_TS  ,
	STG1.EXCEPTION_TYPE_CD  ,
	STG1.PRIORITY_NBR  ,
	STG1.STATUS  ,
	STG1.LOCKED_FLAG  ,
	STG1.LOCKED_ON_TS  ,
	STG1.ACTIVE_FLAG  ,
	STG1.EXCEPTION_ESCALATED_FLAG  ,
	STG1.CONSOLIDATION_CNT  ,
	STG1.FLOW_NAME  ,
	STG1.API_NAME  ,
	STG1.SUB_FLOW_NAME  ,
	STG1.VIEW_ID  ,
	STG1.ERROR_REASON  ,
	STG1.ERROR_TYPE_CD  ,
	STG1.EXPIRATION_DAYS_NBR  ,
	STG1.INBOX_ADDNL_DATA ,
	STG1.LOAD_ID  ,
	STG1.CNT_PROGRAM_NAME  ,
	STG1.RESOLVED_BY_USER_ID  ,
	STG1.BILL_TO_ID ,
	STG1.TEAM_CD ,
	STG1.UNRESOLVE_REALERT_CNT ,
	STG1.UNASSIGN_REALERT_CNT ,
	STG1.INCIDIENT_TYPE_CD ,
	STG1.CLAIMABLE_IND ,
	STG1.AUTO_RESOLVED_FLAG  ,
	STG1.OWNER_ID  ,
	STG1.OWNER_TYPE_CD  ,
	STG1.ASSIGNED_TO_USER_ID  ,
	STG1.LOCKED_BY_USER_ID  ,
	STG1.CREATE_TS  ,
	STG1.CREATE_USER_ID  ,
	STG1.MODIFY_USER_ID  ,
	STG1.MODIFY_TS ,
	STG1.CREATE_PROG_ID  ,
	STG1.MODIFY_PROG_ID  
	
	FROM DEV_EDAP_STAGE_DB.DEV_EDAP_TDM_STAGE_TABLES.INBOX_HISTORY_PRE_STAGE_FOR_PROD STG1
	
	LEFT JOIN  PROD_EDAP_ANALYTICS_DB.PROD_EDAP_ANALYTICS_TABLES.ORDER_LINE  ORDER_LINE
	ON trim(ORDER_LINE.ORDER_LINE_ID) = trim(STG1.ORDER_LINE_ID)
	AND ORDER_LINE.LAST_EFFECTIVE_TS='9999-12-31 23:59:59.000+0000'
	
	LEFT JOIN  PROD_EDAP_ANALYTICS_DB.PROD_EDAP_ANALYTICS_TABLES.ORDER_HEADER  ORDER_HEADER
	ON trim(ORDER_HEADER.ORDER_HEADER_ID) = trim(STG1.ORDER_HEADER_ID)
	AND ORDER_HEADER.LAST_EFFECTIVE_TS='9999-12-31 23:59:59.000+0000'
	
	LEFT JOIN (select * from (select *, row_number() over (partition by (item_id), Coalesce(MARKET_CD,'USA') order by (DELETE_FLAG)  asc nulls last)           as row_id from PROD_EDAP_ANALYTICS_DB.PROD_EDAP_ANALYTICS_TABLES.ITEM 
         where LAST_EFFECTIVE_TS = to_timestamp('9999-12-31 23:59:59.000')) where row_id=1) ITEM
    ON trim(STG1.ITEM_ID) = trim(ITEM.ITEM_ID)
    AND ITEM.MARKET_CD = Coalesce(ORDER_HEADER.MARKET_CD,'USA')
	
	
	LEFT JOIN PROD_EDAP_ANALYTICS_DB.PROD_EDAP_ANALYTICS_TABLES.LOCATION LOC
	ON trim(LOC.LOCATION_ID) = trim(STG1.LOCATION_ID)
	AND LOC.LAST_EFFECTIVE_TS='9999-12-31 23:59:59.000+0000'
	
	LEFT JOIN PROD_EDAP_ANALYTICS_DB.PROD_EDAP_ANALYTICS_TABLES.VENDOR VENDOR  
	ON trim(VENDOR.VENDOR_ID) = trim(SPLIT_PART(STG1.SUPPLIER_ID,'_',2))
	AND VENDOR.LAST_EFFECTIVE_TS='9999-12-31 23:59:59.000+0000' 
	
	LEFT JOIN PROD_EDAP_ANALYTICS_DB.PROD_EDAP_ANALYTICS_TABLES.SHIP_NODE SHIPNODE
	ON trim(SHIPNODE.SHIP_NODE_ID) = trim(STG1.SHIPNODE_ID)
	AND SHIPNODE.LAST_EFFECTIVE_TS='9999-12-31 23:59:59.000+0000'
	
	LEFT JOIN PROD_EDAP_ANALYTICS_DB.PROD_EDAP_ANALYTICS_TABLES.SHIPMENT_JDBC SHIPMENT
	ON trim(SHIPMENT.SOURCE_SHIPMENT_ID) = trim(STG1.SHIPMENT_ID)
	AND SHIPMENT.LAST_EFFECTIVE_TS='9999-12-31 23:59:59.000+0000'
	
	LEFT JOIN PROD_EDAP_ANALYTICS_DB.PROD_EDAP_ANALYTICS_TABLES.CARE_CENTER_QUEUE  QUEUE
	ON trim(QUEUE.QUEUE_ID) = trim(STG1.QUEUE_ID)
	AND QUEUE.LAST_EFFECTIVE_TS='9999-12-31 23:59:59.000+0000'
    
    LEFT JOIN ( select * from (select *,
    ROW_NUMBER() OVER (PARTITION BY trim(SOURCE_WORK_ORDER_ID) ORDER BY first_effective_ts  desc) as rnk 
    from PROD_EDAP_ANALYTICS_DB.PROD_EDAP_ANALYTICS_TABLES.WORK_ORDER where LAST_EFFECTIVE_TS='9999-12-31 23:59:59.000+0000' )
               where rnk=1) WORK_ORDER
    ON trim(STG1.WORK_ORDER_ID)=trim(WORK_ORDER.SOURCE_WORK_ORDER_ID)
	
	/* LEFT JOIN PROD_EDAP_ANALYTICS_DB.PROD_EDAP_ANALYTICS_TABLES.WORK_ORDER  WORK_ORDER
	ON WORK_ORDER.SOURCE_WORK_ORDER_ID = STG1.WORK_ORDER_ID
	AND WORK_ORDER.LAST_EFFECTIVE_TS='9999-12-31 23:59:59.000+0000' */
	
	CROSS JOIN (SELECT MAX(CARE_CENTER_ASSOC_INBOX_KEY) AS MAX_CARE_CENTER_ASSOC_INBOX_KEY 
	FROM PROD_EDAP_ANALYTICS_DB.PROD_EDAP_ANALYTICS_TABLES.CARE_CENTER_ASSOC_INBOX ) TGT_MAX;

-- COMMAND ----------

-- MAGIC %sql
-- MAGIC MERGE INTO PROD_EDAP_ANALYTICS_DB.PROD_EDAP_ANALYTICS_TABLES.CARE_CENTER_ASSOC_INBOX TGT using
-- MAGIC  DEV_EDAP_STAGE_DB.DEV_EDAP_TDM_STAGE_TABLES.INBOX_HISTORY_MAIN_STAGE_FOR_PROD STG 
-- MAGIC  ON TGT.INBOX_ID = STG.INBOX_ID
-- MAGIC  WHEN NOT MATCHED THEN
-- MAGIC  	INSERT
-- MAGIC  	(
-- MAGIC  	CARE_CENTER_ASSOC_INBOX_KEY,
-- MAGIC 	CARE_CENTER_QUEUE_KEY  ,
-- MAGIC 	INBOX_ID  ,
-- MAGIC 	INBOX_TYPE_CD  ,
-- MAGIC 	PARENT_INBOX_ID  ,
-- MAGIC 	ORDER_HEADER_KEY  ,
-- MAGIC 	ORDER_HEADER_ID ,
-- MAGIC 	ORDER_LINE_KEY ,
-- MAGIC 	ORDER_LINE_ID  ,
-- MAGIC 	ORDER_ID  ,
-- MAGIC 	SUPPLIER_KEY  ,
-- MAGIC 	SUPPLIER_ID ,
-- MAGIC 	SHIPMENT_KEY  ,
-- MAGIC 	SHIPMENT_ID ,
-- MAGIC 	SHIPMENT_NBR ,
-- MAGIC 	CNT_REQUEST_ID  ,
-- MAGIC 	ENTERPRISE_CD  ,
-- MAGIC 	WORK_ORDER_KEY ,
-- MAGIC 	WORK_ORDER_ID  ,
-- MAGIC 	WORK_ORDER_NBR ,
-- MAGIC 	LOCATION_KEY ,
-- MAGIC 	LOCATION_ID  ,
-- MAGIC 	WAVE_KEY  ,
-- MAGIC 	WAVE_ID  ,
-- MAGIC 	WAVE_NBR ,
-- MAGIC 	MOVE_REQUEST_ID  ,
-- MAGIC 	SHIPNODE_KEY  ,
-- MAGIC 	SHIPNODE_ID  ,
-- MAGIC 	ITEM_KEY ,
-- MAGIC 	ITEM_ID  ,
-- MAGIC 	QUEUE_ID ,
-- MAGIC 	FIRST_EFFECTIVE_TS  ,
-- MAGIC 	LAST_EFFECTIVE_TS  ,
-- MAGIC 	DESCRIPTION  ,
-- MAGIC 	DETAIL_DESC  ,
-- MAGIC 	LIST_DESC  ,
-- MAGIC 	GENERATED_TS  ,
-- MAGIC 	RESOLUTION_TS  ,
-- MAGIC 	RESOLVE_BY_TS  ,
-- MAGIC 	LAST_UNASSIGN_ALERT_TS  ,
-- MAGIC 	LAST_UNRESOLVE_ALERT_TS  ,
-- MAGIC 	CLOSED_ON_TS  ,
-- MAGIC 	FOLLOWUP_TS  ,
-- MAGIC 	LAST_EXCEED_ALERT_TS  ,
-- MAGIC 	LAST_OCCURRED_ON_TS  ,
-- MAGIC 	EXCEPTION_TYPE_CD  ,
-- MAGIC 	PRIORITY_NBR  ,
-- MAGIC 	STATUS  ,
-- MAGIC 	LOCKED_FLAG  ,
-- MAGIC 	LOCKED_ON_TS  ,
-- MAGIC 	ACTIVE_FLAG  ,
-- MAGIC 	EXCEPTION_ESCALATED_FLAG  ,
-- MAGIC 	CONSOLIDATION_CNT  ,
-- MAGIC 	FLOW_NAME  ,
-- MAGIC 	API_NAME  ,
-- MAGIC 	SUB_FLOW_NAME  ,
-- MAGIC 	VIEW_ID  ,
-- MAGIC 	ERROR_REASON  ,
-- MAGIC 	ERROR_TYPE_CD  ,
-- MAGIC 	EXPIRATION_DAYS_NBR  ,
-- MAGIC 	INBOX_ADDNL_DATA ,
-- MAGIC 	LOAD_ID  ,
-- MAGIC 	CNT_PROGRAM_NAME  ,
-- MAGIC 	RESOLVED_BY_USER_ID  ,
-- MAGIC 	BILL_TO_ID ,
-- MAGIC 	TEAM_CD ,
-- MAGIC 	UNRESOLVE_REALERT_CNT ,
-- MAGIC 	UNASSIGN_REALERT_CNT ,
-- MAGIC 	INCIDIENT_TYPE_CD ,
-- MAGIC 	CLAIMABLE_IND ,
-- MAGIC 	AUTO_RESOLVED_FLAG  ,
-- MAGIC 	OWNER_ID  ,
-- MAGIC 	OWNER_TYPE_CD  ,
-- MAGIC 	ASSIGNED_TO_USER_ID  ,
-- MAGIC 	LOCKED_BY_USER_ID  ,
-- MAGIC 	CREATE_TS  ,
-- MAGIC 	CREATE_USER_ID  ,
-- MAGIC 	MODIFY_USER_ID  ,
-- MAGIC 	MODIFY_TS ,
-- MAGIC 	CREATE_PROG_ID  ,
-- MAGIC 	MODIFY_PROG_ID , 
-- MAGIC  	INSERT_TS,
-- MAGIC  	UPDATE_TS
-- MAGIC  	)
-- MAGIC  	VALUES
-- MAGIC  	(
-- MAGIC  	STG.CARE_CENTER_ASSOC_INBOX_KEY,
-- MAGIC 	STG.CARE_CENTER_QUEUE_KEY  ,
-- MAGIC 	STG.INBOX_ID  ,
-- MAGIC 	STG.INBOX_TYPE_CD  ,
-- MAGIC 	STG.PARENT_INBOX_ID  ,
-- MAGIC 	STG.ORDER_HEADER_KEY  ,
-- MAGIC 	STG.ORDER_HEADER_ID ,
-- MAGIC 	STG.ORDER_LINE_KEY ,
-- MAGIC 	STG.ORDER_LINE_ID  ,
-- MAGIC 	STG.ORDER_ID  ,
-- MAGIC 	STG.SUPPLIER_KEY  ,
-- MAGIC 	STG.SUPPLIER_ID ,
-- MAGIC 	STG.SHIPMENT_KEY  ,
-- MAGIC 	STG.SHIPMENT_ID ,
-- MAGIC 	STG.SHIPMENT_NBR ,
-- MAGIC 	STG.CNT_REQUEST_ID  ,
-- MAGIC 	STG.ENTERPRISE_CD  ,
-- MAGIC 	STG.WORK_ORDER_KEY ,
-- MAGIC 	STG.WORK_ORDER_ID  ,
-- MAGIC 	STG.WORK_ORDER_NBR ,
-- MAGIC 	STG.LOCATION_KEY ,
-- MAGIC 	STG.LOCATION_ID  ,
-- MAGIC 	STG.WAVE_KEY  ,
-- MAGIC 	STG.WAVE_ID  ,
-- MAGIC 	STG.WAVE_NBR ,
-- MAGIC 	STG.MOVE_REQUEST_ID  ,
-- MAGIC 	STG.SHIPNODE_KEY  ,
-- MAGIC 	STG.SHIPNODE_ID  ,
-- MAGIC 	STG.ITEM_KEY ,
-- MAGIC 	STG.ITEM_ID  ,
-- MAGIC 	STG.QUEUE_ID ,
-- MAGIC 	STG.FIRST_EFFECTIVE_TS  ,
-- MAGIC 	STG.LAST_EFFECTIVE_TS  ,
-- MAGIC 	STG.DESCRIPTION  ,
-- MAGIC 	STG.DETAIL_DESC  ,
-- MAGIC 	STG.LIST_DESC  ,
-- MAGIC 	STG.GENERATED_TS  ,
-- MAGIC 	TO_TIMESTAMP(STG.RESOLUTION_TS)  ,
-- MAGIC 	STG.RESOLVE_BY_TS  ,
-- MAGIC 	STG.LAST_UNASSIGN_ALERT_TS  ,
-- MAGIC 	STG.LAST_UNRESOLVE_ALERT_TS  ,
-- MAGIC 	STG.CLOSED_ON_TS  ,
-- MAGIC 	TO_TIMESTAMP(STG.FOLLOWUP_TS)  ,
-- MAGIC 	STG.LAST_EXCEED_ALERT_TS  ,
-- MAGIC 	STG.LAST_OCCURRED_ON_TS  ,
-- MAGIC 	STG.EXCEPTION_TYPE_CD  ,
-- MAGIC 	STG.PRIORITY_NBR  ,
-- MAGIC 	STG.STATUS  ,
-- MAGIC 	STG.LOCKED_FLAG  ,
-- MAGIC 	STG.LOCKED_ON_TS  ,
-- MAGIC 	STG.ACTIVE_FLAG  ,
-- MAGIC 	STG.EXCEPTION_ESCALATED_FLAG  ,
-- MAGIC 	STG.CONSOLIDATION_CNT  ,
-- MAGIC 	STG.FLOW_NAME  ,
-- MAGIC 	STG.API_NAME  ,
-- MAGIC 	STG.SUB_FLOW_NAME  ,
-- MAGIC 	STG.VIEW_ID  ,
-- MAGIC 	STG.ERROR_REASON  ,
-- MAGIC 	STG.ERROR_TYPE_CD  ,
-- MAGIC 	STG.EXPIRATION_DAYS_NBR  ,
-- MAGIC 	STG.INBOX_ADDNL_DATA ,
-- MAGIC 	STG.LOAD_ID  ,
-- MAGIC 	STG.CNT_PROGRAM_NAME  ,
-- MAGIC 	STG.RESOLVED_BY_USER_ID  ,
-- MAGIC 	STG.BILL_TO_ID ,
-- MAGIC 	STG.TEAM_CD ,
-- MAGIC 	STG.UNRESOLVE_REALERT_CNT ,
-- MAGIC 	STG.UNASSIGN_REALERT_CNT ,
-- MAGIC 	STG.INCIDIENT_TYPE_CD ,
-- MAGIC 	STG.CLAIMABLE_IND ,
-- MAGIC 	STG.AUTO_RESOLVED_FLAG  ,
-- MAGIC 	STG.OWNER_ID  ,
-- MAGIC 	STG.OWNER_TYPE_CD  ,
-- MAGIC 	STG.ASSIGNED_TO_USER_ID  ,
-- MAGIC 	STG.LOCKED_BY_USER_ID  ,
-- MAGIC 	STG.CREATE_TS  ,
-- MAGIC 	STG.CREATE_USER_ID  ,
-- MAGIC 	STG.MODIFY_USER_ID  ,
-- MAGIC 	STG.MODIFY_TS ,
-- MAGIC 	STG.CREATE_PROG_ID  ,
-- MAGIC 	STG.MODIFY_PROG_ID ,  
-- MAGIC 	TO_TIMESTAMP(CURRENT_TIMESTAMP()) ,
-- MAGIC 	TO_TIMESTAMP(CURRENT_TIMESTAMP()) 
-- MAGIC  	);

-- COMMAND ----------

-- MAGIC %sql
-- MAGIC MERGE INTO PROD_EDAP_L1_DB.PROD_EDAP_L1_TABLES.STERLING_CUST_CARE_CC_ASSOC_INBOX_TABLE_ARCHIVE INBOX
-- MAGIC 	USING DEV_EDAP_STAGE_DB.DEV_EDAP_TDM_STAGE_TABLES.INBOX_HISTORY_MAIN_STAGE_FOR_PROD STG 
-- MAGIC 	ON INBOX.INBOX_KEY = STG.INBOX_ID
-- MAGIC 	WHEN NOT MATCHED THEN
-- MAGIC 	INSERT  
-- MAGIC 	(
-- MAGIC 	INBOX.GENERATED_ON ,
-- MAGIC 	INBOX.RESOLUTION_DATE ,
-- MAGIC 	INBOX.PRIORITY ,
-- MAGIC 	INBOX.RESOLVE_BY ,
-- MAGIC 	INBOX.LAST_UNASSIGN_ALERT ,
-- MAGIC 	INBOX.LAST_UNRESOLVE_ALERT ,
-- MAGIC 	INBOX.LOCKED_ON ,
-- MAGIC 	INBOX.CLOSED_ON ,
-- MAGIC 	INBOX.FOLLOWUP_DATE ,
-- MAGIC 	INBOX.LAST_EXCEED_ALERT ,
-- MAGIC 	INBOX.CONSOLIDATION_COUNT ,
-- MAGIC 	INBOX.LAST_OCCURRED_ON ,
-- MAGIC 	INBOX.EXPIRATION_DAYS ,
-- MAGIC 	INBOX.LOCKID ,
-- MAGIC 	INBOX.CREATETS ,
-- MAGIC 	INBOX.MODIFYTS ,
-- MAGIC 	INBOX.UNRESOLVE_REALERT_COUNT ,
-- MAGIC 	INBOX.UNASSIGN_REALERT_COUNT ,
-- MAGIC 	INBOX.INBOX_KEY ,
-- MAGIC 	INBOX.INBOX_TYPE ,
-- MAGIC 	INBOX.DESCRIPTION ,
-- MAGIC 	INBOX.QUEUE_KEY ,
-- MAGIC 	INBOX.ENTERPRISE_KEY ,
-- MAGIC 	INBOX.SHIPNODE_KEY ,
-- MAGIC 	INBOX.EXCEPTION_TYPE ,
-- MAGIC 	INBOX.AUTO_RESOLVED_FLAG ,
-- MAGIC 	INBOX.LOCKED_FLAG ,
-- MAGIC 	INBOX.LOCKED_BY_USER_KEY ,
-- MAGIC 	INBOX.PARENT_INBOX_KEY ,
-- MAGIC 	INBOX.DETAIL_DESCRIPTION ,
-- MAGIC 	INBOX.LIST_DESCRIPTION ,
-- MAGIC 	INBOX.STATUS ,
-- MAGIC 	INBOX.ACTIVE_FLAG ,
-- MAGIC 	INBOX.EXCEPTION_ESCALATED_FLAG ,
-- MAGIC 	INBOX.OWNER_TYPE ,
-- MAGIC 	INBOX.OWNER_KEY ,
-- MAGIC 	INBOX.ASSIGNED_TO_USER_KEY ,
-- MAGIC 	INBOX.FLOW_NAME ,
-- MAGIC 	INBOX.API_NAME ,
-- MAGIC 	INBOX.SUB_FLOW_NAME ,
-- MAGIC 	INBOX.VIEW_ID ,
-- MAGIC 	INBOX.ERROR_REASON ,
-- MAGIC 	INBOX.ERROR_TYPE ,
-- MAGIC 	INBOX.INBOX_ADDNL_DATA ,
-- MAGIC 	INBOX.CREATEUSERID ,
-- MAGIC 	INBOX.MODIFYUSERID ,
-- MAGIC 	INBOX.CREATEPROGID ,
-- MAGIC 	INBOX.MODIFYPROGID ,
-- MAGIC 	INBOX.SUPPLIER_KEY ,
-- MAGIC 	INBOX.ORDER_HEADER_KEY ,
-- MAGIC 	INBOX.ORDER_NO ,
-- MAGIC 	INBOX.SHIPMENT_KEY ,
-- MAGIC 	INBOX.COUNT_REQUEST_KEY ,
-- MAGIC 	INBOX.SHIPMENT_NO ,
-- MAGIC 	INBOX.LOAD_NO ,
-- MAGIC 	INBOX.COUNT_PROGRAM_NAME ,
-- MAGIC 	INBOX.ITEM_ID ,
-- MAGIC 	INBOX.ORDER_LINE_KEY ,
-- MAGIC 	INBOX.MOVE_REQUEST_KEY ,
-- MAGIC 	INBOX.LOCATION_ID ,
-- MAGIC 	INBOX.WAVE_KEY ,
-- MAGIC 	INBOX.WAVE_NO ,
-- MAGIC 	INBOX.WORK_ORDER_KEY ,
-- MAGIC 	INBOX.WORK_ORDER_NO ,
-- MAGIC 	INBOX.RESOLVED_BY_USER_ID ,
-- MAGIC 	INBOX.BILL_TO_ID ,
-- MAGIC 	INBOX.TEAM_CODE ,
-- MAGIC 	INBOX.EXTN_INCIDIENT_TYPE ,
-- MAGIC 	INBOX.EXTN_CLAIMABLE_INDICATOR ,
-- MAGIC 	INBOX.MARKET_CD
-- MAGIC 	)
-- MAGIC 	VALUES
-- MAGIC 	(
-- MAGIC 	STG.GENERATED_TS  ,
-- MAGIC 	TO_TIMESTAMP(STG.RESOLUTION_TS)  ,
-- MAGIC 	STG.PRIORITY_NBR  ,
-- MAGIC 	STG.RESOLVE_BY_TS  ,
-- MAGIC 	STG.LAST_UNASSIGN_ALERT_TS  ,
-- MAGIC 	STG.LAST_UNRESOLVE_ALERT_TS  ,
-- MAGIC 	STG.LOCKED_ON_TS  ,
-- MAGIC 	STG.CLOSED_ON_TS  ,
-- MAGIC 	TO_TIMESTAMP(STG.FOLLOWUP_TS)  ,
-- MAGIC 	STG.LAST_EXCEED_ALERT_TS  ,
-- MAGIC 	STG.CONSOLIDATION_CNT  ,
-- MAGIC 	STG.LAST_OCCURRED_ON_TS  ,
-- MAGIC 	STG.EXPIRATION_DAYS_NBR  ,
-- MAGIC 	0 ,
-- MAGIC 	STG.CREATE_TS  ,
-- MAGIC 	STG.MODIFY_TS ,
-- MAGIC 	STG.UNRESOLVE_REALERT_CNT ,
-- MAGIC 	STG.UNASSIGN_REALERT_CNT ,
-- MAGIC 	STG.INBOX_ID  ,
-- MAGIC 	STG.INBOX_TYPE_CD  ,
-- MAGIC 	STG.DESCRIPTION  ,
-- MAGIC 	STG.QUEUE_ID ,
-- MAGIC 	STG.ENTERPRISE_CD  ,
-- MAGIC 	STG.SHIPNODE_ID  ,
-- MAGIC 	STG.EXCEPTION_TYPE_CD  ,
-- MAGIC 	STG.AUTO_RESOLVED_FLAG  ,
-- MAGIC 	STG.LOCKED_FLAG  ,
-- MAGIC 	STG.LOCKED_BY_USER_ID  ,
-- MAGIC 	STG.PARENT_INBOX_ID  ,
-- MAGIC 	STG.DETAIL_DESC  ,
-- MAGIC 	STG.LIST_DESC  ,
-- MAGIC 	STG.STATUS  ,
-- MAGIC 	STG.ACTIVE_FLAG  ,
-- MAGIC 	STG.EXCEPTION_ESCALATED_FLAG  ,
-- MAGIC 	STG.OWNER_TYPE_CD  ,
-- MAGIC 	STG.OWNER_ID  ,
-- MAGIC 	STG.ASSIGNED_TO_USER_ID  ,
-- MAGIC 	STG.FLOW_NAME  ,
-- MAGIC 	STG.API_NAME  ,
-- MAGIC 	STG.SUB_FLOW_NAME  ,
-- MAGIC 	STG.VIEW_ID  ,
-- MAGIC 	STG.ERROR_REASON  ,
-- MAGIC 	STG.ERROR_TYPE_CD  ,
-- MAGIC 	STG.INBOX_ADDNL_DATA ,
-- MAGIC 	STG.CREATE_USER_ID  ,
-- MAGIC 	STG.MODIFY_USER_ID  ,
-- MAGIC 	STG.CREATE_PROG_ID  ,
-- MAGIC 	STG.MODIFY_PROG_ID ,  
-- MAGIC 	STG.SUPPLIER_ID ,
-- MAGIC 	STG.ORDER_HEADER_ID ,
-- MAGIC 	STG.ORDER_ID  ,
-- MAGIC 	STG.SHIPMENT_ID ,
-- MAGIC 	STG.CNT_REQUEST_ID  ,
-- MAGIC 	STG.SHIPMENT_NBR ,
-- MAGIC 	STG.LOAD_ID  ,
-- MAGIC 	STG.CNT_PROGRAM_NAME  ,
-- MAGIC 	STG.ITEM_ID  ,
-- MAGIC 	STG.ORDER_LINE_ID  ,
-- MAGIC 	STG.MOVE_REQUEST_ID  ,
-- MAGIC 	STG.LOCATION_ID  ,
-- MAGIC 	STG.WAVE_ID  ,
-- MAGIC 	STG.WAVE_NBR ,
-- MAGIC 	STG.WORK_ORDER_ID  ,
-- MAGIC 	STG.WORK_ORDER_NBR ,
-- MAGIC 	STG.RESOLVED_BY_USER_ID  ,
-- MAGIC 	STG.BILL_TO_ID ,
-- MAGIC 	STG.TEAM_CD ,
-- MAGIC 	STG.INCIDIENT_TYPE_CD ,
-- MAGIC 	STG.CLAIMABLE_IND ,
-- MAGIC 	''
-- MAGIC 	);
