-- Databricks notebook source
-- MAGIC %md
-- MAGIC Create table for ORDER_AUDIT_HIST_MAIN_STAGE (ORDER_AUDIT_HIST_STAGE)

-- COMMAND ----------

-- MAGIC %sql
-- MAGIC create or replace TABLE DEV_EDAP_STAGE_DB.DEV_EDAP_TDM_STAGE_TABLES.ORDER_AUDIT_HIST_STAGE (
-- MAGIC 	ORDER_AUDIT_KEY NUMBER(38,0) NOT NULL,
-- MAGIC 	ORDER_AUDIT_ID VARCHAR(16777216) NOT NULL,
-- MAGIC 	ORDER_HEADER_KEY NUMBER(38,0) NOT NULL,
-- MAGIC 	ORDER_HEADER_ID VARCHAR(16777216) NOT NULL,
-- MAGIC 	ORDER_ID VARCHAR(16777216) NOT NULL,
-- MAGIC 	ORDER_DT DATE,
-- MAGIC 	ORDER_LINE_KEY NUMBER(38,0) NOT NULL,
-- MAGIC 	ORDER_LINE_ID VARCHAR(16777216) NOT NULL,
-- MAGIC 	ORDER_RELEASE_KEY NUMBER(38,0) NOT NULL,
-- MAGIC 	ORDER_RELEASE_ID VARCHAR(16777216) NOT NULL,
-- MAGIC 	ORDER_RELEASE_LINE_ID VARCHAR(16777216) NOT NULL,
-- MAGIC 	FIRST_EFFECTIVE_TS TIMESTAMP_NTZ(9) NOT NULL,
-- MAGIC 	LAST_EFFECTIVE_TS TIMESTAMP_NTZ(9) NOT NULL,
-- MAGIC 	AUDIT_TRANSACTION_ID VARCHAR(16777216),
-- MAGIC 	MODIFICATION_TYPE_CD VARCHAR(16777216),
-- MAGIC 	MODIFICATION_LEVEL VARCHAR(16777216),
-- MAGIC 	OLD_BUFFER VARCHAR(16777216),
-- MAGIC 	NEW_BUFFER VARCHAR(16777216),
-- MAGIC 	REFERENCE_1 VARCHAR(16777216),
-- MAGIC 	REFERENCE_2 VARCHAR(16777216),
-- MAGIC 	REFERENCE_3 VARCHAR(16777216),
-- MAGIC 	REFERENCE_4 VARCHAR(16777216),
-- MAGIC 	DATA_SOURCE_CD VARCHAR(16777216),
-- MAGIC 	SEQUENCE_NBR NUMBER(38,0),
-- MAGIC 	REASON_CD VARCHAR(16777216),
-- MAGIC 	REASON_DESC VARCHAR(16777216),
-- MAGIC 	CREATE_TS TIMESTAMP_NTZ(9),
-- MAGIC 	MODIFY_TS TIMESTAMP_NTZ(9),
-- MAGIC 	CREATE_USER_ID VARCHAR(16777216),
-- MAGIC 	MODIFY_USER_ID VARCHAR(16777216),
-- MAGIC 	CREATE_PROG_ID VARCHAR(16777216),
-- MAGIC 	MODIFY_PROG_ID VARCHAR(16777216),
-- MAGIC 	INSERT_TS TIMESTAMP_NTZ(9) NOT NULL,
-- MAGIC 	UPDATE_TS TIMESTAMP_NTZ(9) NOT NULL
-- MAGIC );

-- COMMAND ----------

-- MAGIC %md
-- MAGIC SK generation logic query and insert into PRE_STAGE to MAIN_STAGE

-- COMMAND ----------

-- MAGIC %sql
-- MAGIC insert overwrite into  DEV_EDAP_STAGE_DB.DEV_EDAP_TDM_STAGE_TABLES.ORDER_AUDIT_HIST_STAGE  
-- MAGIC       SELECT 
-- MAGIC 		CASE 
-- MAGIC 	    WHEN COALESCE (stg1.ORDER_AUDIT_KEY,-1) = -1 THEN 
-- MAGIC 		DENSE_RANK() OVER (ORDER BY stg1.ORDER_AUDIT_KEY, stg1.ORDER_AUDIT_ID ) + COALESCE(MAX_ORDER_AUDIT_KEY,0) 
-- MAGIC 	    ELSE stg1.ORDER_AUDIT_KEY 
-- MAGIC 		END AS ORDER_AUDIT_KEY,
-- MAGIC 			stg1.ORDER_AUDIT_ID,	 	
-- MAGIC 	COALESCE(OH.ORDER_HEADER_KEY,-1) as ORDER_HEADER_KEY,
-- MAGIC 			stg1.ORDER_HEADER_ID,
-- MAGIC 			stg1.ORDER_ID,
-- MAGIC 			stg1.ORDER_DT,
-- MAGIC     COALESCE(OL.ORDER_LINE_KEY,-1) as ORDER_LINE_KEY,
-- MAGIC 			stg1.ORDER_LINE_ID,
-- MAGIC 	COALESCE(ORS.ORDER_RELEASE_KEY,-1) as ORDER_RELEASE_KEY, 
-- MAGIC 			stg1.ORDER_RELEASE_ID,
-- MAGIC 			stg1.ORDER_RELEASE_LINE_ID,
-- MAGIC 			stg1.FIRST_EFFECTIVE_TS,	
-- MAGIC 			stg1.LAST_EFFECTIVE_TS,	
-- MAGIC 			stg1.AUDIT_TRANSACTION_ID,	 	
-- MAGIC 			stg1.MODIFICATION_TYPE_CD,	
-- MAGIC 			stg1.MODIFICATION_LEVEL,
-- MAGIC 			stg1.OLD_BUFFER,	
-- MAGIC 			stg1.NEW_BUFFER,	
-- MAGIC 			stg1.REFERENCE_1, 	
-- MAGIC 			stg1.REFERENCE_2,	
-- MAGIC 			stg1.REFERENCE_3, 	
-- MAGIC 			stg1.REFERENCE_4, 	
-- MAGIC 			stg1.DATA_SOURCE_CD,	 	
-- MAGIC 			stg1.SEQUENCE_NBR,
-- MAGIC 			stg1.REASON_CD,	
-- MAGIC 			stg1.REASON_DESC,
-- MAGIC 			stg1.CREATE_TS,	
-- MAGIC 			stg1.MODIFY_TS,	
-- MAGIC 			stg1.CREATE_USER_ID,		
-- MAGIC 			stg1.MODIFY_USER_ID,	 	
-- MAGIC 			stg1.CREATE_PROG_ID, 	
-- MAGIC 			stg1.MODIFY_PROG_ID,
-- MAGIC 			stg1.INSERT_TS,
-- MAGIC 			stg1.UPDATE_TS
-- MAGIC         from DEV_EDAP_STAGE_DB.DEV_EDAP_TDM_STAGE_TABLES.ORDER_AUDIT_HIST_PRE_STAGE  stg1
-- MAGIC         
-- MAGIC                       left join PROD_EDAP_ANALYTICS_DB.PROD_EDAP_ANALYTICS_TABLES.ORDER_RELEASE ORS ON 
-- MAGIC                       stg1.ORDER_RELEASE_ID = ORS.ORDER_RELEASE_ID
-- MAGIC                       AND ORS.LAST_EFFECTIVE_TS = '9999-12-31 23:59:59.000+0000'
-- MAGIC                       
-- MAGIC                       left join PROD_EDAP_ANALYTICS_DB.PROD_EDAP_ANALYTICS_TABLES.ORDER_HEADER OH ON 
-- MAGIC                       stg1.ORDER_HEADER_ID = OH.ORDER_HEADER_ID
-- MAGIC                       AND OH.LAST_EFFECTIVE_TS = '9999-12-31 23:59:59.000+0000'
-- MAGIC                       
-- MAGIC                       left join PROD_EDAP_ANALYTICS_DB.PROD_EDAP_ANALYTICS_TABLES.ORDER_LINE OL ON 
-- MAGIC                       stg1.ORDER_LINE_ID = OL.ORDER_LINE_ID
-- MAGIC                       AND OL.LAST_EFFECTIVE_TS = '9999-12-31 23:59:59.000+0000'
-- MAGIC         
-- MAGIC         
-- MAGIC             CROSS JOIN (SELECT MAX(ORDER_AUDIT_KEY) AS MAX_ORDER_AUDIT_KEY FROM 
-- MAGIC             PROD_EDAP_ANALYTICS_DB.PROD_EDAP_ANALYTICS_TABLES.ORDER_AUDIT WHERE ORDER_AUDIT_KEY <> -1 ) TGT_MAX;

-- COMMAND ----------

-- DBTITLE 1,backup of prod TGT and ARCHIVE table
create table PROD_EDAP_ANALYTICS_DB.PROD_EDAP_ANALYTICS_TABLES.ORDER_AUDIT_BACKUP_25_4 CLONE PROD_EDAP_ANALYTICS_DB.PROD_EDAP_ANALYTICS_TABLES.ORDER_AUDIT;

create table PROD_EDAP_L1_DB.PROD_EDAP_L1_TABLES.STERLING_ORDER_ORDER_AUDIT_TABLE_ARCHIVE_BACKUP_25_4 CLONE
PROD_EDAP_L1_DB.PROD_EDAP_L1_TABLES.STERLING_ORDER_ORDER_AUDIT_TABLE_ARCHIVE;

-- COMMAND ----------

-- MAGIC %md
-- MAGIC Merge into TGT table_(ORDER_AUDIT) from main stage table_(ORDER_AUDIT_HIST_STAGE)

-- COMMAND ----------

-- MAGIC %sql
-- MAGIC MERGE into PROD_EDAP_ANALYTICS_DB.PROD_EDAP_ANALYTICS_TABLES.ORDER_AUDIT tgt using
-- MAGIC DEV_EDAP_STAGE_DB.DEV_EDAP_TDM_STAGE_TABLES.ORDER_AUDIT_HIST_STAGE stg 
-- MAGIC on tgt.ORDER_AUDIT_ID = stg.ORDER_AUDIT_ID
-- MAGIC when not matched then
-- MAGIC 	insert
-- MAGIC 	(
-- MAGIC 	        ORDER_AUDIT_KEY,
-- MAGIC 			ORDER_AUDIT_ID,	 	
-- MAGIC 			ORDER_HEADER_KEY,
-- MAGIC 			ORDER_HEADER_ID,
-- MAGIC 			ORDER_ID,
-- MAGIC 			ORDER_DT,
-- MAGIC 			ORDER_LINE_KEY,
-- MAGIC 			ORDER_LINE_ID,
-- MAGIC 			ORDER_RELEASE_KEY, 
-- MAGIC 			ORDER_RELEASE_ID,
-- MAGIC 			ORDER_RELEASE_LINE_ID,
-- MAGIC 			FIRST_EFFECTIVE_TS,	
-- MAGIC 			LAST_EFFECTIVE_TS,	
-- MAGIC 			AUDIT_TRANSACTION_ID,	 	
-- MAGIC 			MODIFICATION_TYPE_CD,	
-- MAGIC 			MODIFICATION_LEVEL,
-- MAGIC 			OLD_BUFFER,	
-- MAGIC 			NEW_BUFFER,	
-- MAGIC 			REFERENCE_1, 	
-- MAGIC 			REFERENCE_2,	
-- MAGIC 			REFERENCE_3, 	
-- MAGIC 			REFERENCE_4, 	
-- MAGIC 			DATA_SOURCE_CD,	 	
-- MAGIC 			SEQUENCE_NBR,
-- MAGIC 			REASON_CD,	
-- MAGIC 			REASON_DESC,
-- MAGIC 			CREATE_TS,	
-- MAGIC 			MODIFY_TS,	
-- MAGIC 			CREATE_USER_ID,		
-- MAGIC 			MODIFY_USER_ID,	 	
-- MAGIC 			CREATE_PROG_ID, 	
-- MAGIC 			MODIFY_PROG_ID,
-- MAGIC 			INSERT_TS,
-- MAGIC 			UPDATE_TS
-- MAGIC 
-- MAGIC 	)
-- MAGIC 	values
-- MAGIC 	(
-- MAGIC         stg.ORDER_AUDIT_KEY,
-- MAGIC         stg.ORDER_AUDIT_ID,	 	
-- MAGIC         stg.ORDER_HEADER_KEY,
-- MAGIC         stg.ORDER_HEADER_ID,
-- MAGIC         stg.ORDER_ID,
-- MAGIC         stg.ORDER_DT,
-- MAGIC         stg.ORDER_LINE_KEY,
-- MAGIC         stg.ORDER_LINE_ID,
-- MAGIC         stg.ORDER_RELEASE_KEY, 
-- MAGIC         stg.ORDER_RELEASE_ID,
-- MAGIC         stg.ORDER_RELEASE_LINE_ID,
-- MAGIC         stg.FIRST_EFFECTIVE_TS,	
-- MAGIC         stg.LAST_EFFECTIVE_TS,	
-- MAGIC         stg.AUDIT_TRANSACTION_ID,	 	
-- MAGIC         stg.MODIFICATION_TYPE_CD,	
-- MAGIC         stg.MODIFICATION_LEVEL,
-- MAGIC         stg.OLD_BUFFER,	
-- MAGIC         stg.NEW_BUFFER,	
-- MAGIC         stg.REFERENCE_1, 	
-- MAGIC         stg.REFERENCE_2,	
-- MAGIC         stg.REFERENCE_3, 	
-- MAGIC         stg.REFERENCE_4, 	
-- MAGIC         stg.DATA_SOURCE_CD,	 	
-- MAGIC         stg.SEQUENCE_NBR,
-- MAGIC         stg.REASON_CD,	
-- MAGIC         stg.REASON_DESC,
-- MAGIC         stg.CREATE_TS,	
-- MAGIC         stg.MODIFY_TS,	
-- MAGIC         stg.CREATE_USER_ID,		
-- MAGIC         stg.MODIFY_USER_ID,	 	
-- MAGIC         stg.CREATE_PROG_ID, 	
-- MAGIC         stg.MODIFY_PROG_ID,
-- MAGIC         stg.INSERT_TS,
-- MAGIC         stg.UPDATE_TS
-- MAGIC       );

-- COMMAND ----------

-- MAGIC %md
-- MAGIC Merge into Archive_(STERLING_ORDER_ORDER_AUDIT_TABLE_ARCHIVE) table from main stage table_(ORDER_AUDIT_HIST_STAGE)

-- COMMAND ----------

-- MAGIC %sql
-- MAGIC MERGE into PROD_EDAP_L1_DB.PROD_EDAP_L1_TABLES.STERLING_ORDER_ORDER_AUDIT_TABLE_ARCHIVE tgt using 
-- MAGIC      DEV_EDAP_STAGE_DB.DEV_EDAP_TDM_STAGE_TABLES.ORDER_AUDIT_HIST_STAGE stg
-- MAGIC     on tgt.ORDER_AUDIT_KEY = stg.ORDER_AUDIT_ID
-- MAGIC     when not matched then
-- MAGIC     insert (    SEQ_NO,
-- MAGIC 	            LOCKID,
-- MAGIC 	            ORDER_DT,
-- MAGIC 	            ORDER_AUDIT_KEY,
-- MAGIC 	            ORDER_HEADER_KEY,
-- MAGIC 	            ORDER_LINE_KEY,
-- MAGIC 	            ORDER_RELEASE_KEY,
-- MAGIC 	            ORDER_RELEASE_LINE_KEY,
-- MAGIC 	            MODIFICATION_TYPE,
-- MAGIC 	            MODIFICATION_LEVEL,
-- MAGIC 	            OLD_BUFFER,
-- MAGIC 	            NEW_BUFFER,
-- MAGIC 	            REFERENCE_1,
-- MAGIC 	            REFERENCE_2,
-- MAGIC 	            REFERENCE_3,
-- MAGIC 	            REFERENCE_4,
-- MAGIC 	            AUDIT_TRANSACTION_ID,
-- MAGIC 	            DATA_ID,
-- MAGIC 	            REASON_CODE,
-- MAGIC 	            REASON_TEXT,
-- MAGIC 	            XML_FORMAT,
-- MAGIC 	            CREATETS,
-- MAGIC 	            MODIFYTS,
-- MAGIC 	            CREATEUSERID,
-- MAGIC 	            MODIFYUSERID,
-- MAGIC 	            CREATEPROGID,
-- MAGIC 	            MODIFYPROGID,
-- MAGIC 	            ORDER_ID
-- MAGIC          )
-- MAGIC    values
-- MAGIC         (
-- MAGIC         stg.SEQUENCE_NBR,
-- MAGIC         0,	 	
-- MAGIC         stg.ORDER_DT,
-- MAGIC         stg.ORDER_AUDIT_ID,
-- MAGIC         stg.ORDER_HEADER_ID,
-- MAGIC         stg.ORDER_LINE_ID,
-- MAGIC         stg.ORDER_RELEASE_ID,
-- MAGIC         stg.ORDER_RELEASE_LINE_ID,
-- MAGIC         stg.MODIFICATION_TYPE_CD, 
-- MAGIC         stg.MODIFICATION_LEVEL,
-- MAGIC         stg.OLD_BUFFER,
-- MAGIC         stg.NEW_BUFFER,	
-- MAGIC         stg.REFERENCE_1,	
-- MAGIC         stg.REFERENCE_2,	 	
-- MAGIC         stg.REFERENCE_3,	
-- MAGIC         stg.REFERENCE_4,
-- MAGIC         stg.AUDIT_TRANSACTION_ID,	
-- MAGIC         stg.DATA_SOURCE_CD,	
-- MAGIC         stg.REASON_CD, 	
-- MAGIC         stg.REASON_DESC,
-- MAGIC         'Y',
-- MAGIC         stg.CREATE_TS, 	
-- MAGIC         stg.MODIFY_TS, 	
-- MAGIC         stg.CREATE_USER_ID,	 	
-- MAGIC         stg.MODIFY_USER_ID,
-- MAGIC         stg.CREATE_PROG_ID,	
-- MAGIC         stg.MODIFY_PROG_ID,
-- MAGIC         stg.ORDER_ID ) ;     
