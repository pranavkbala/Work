MERGE INTO L2_ANALYTICS_TABLES.LOCATION_ITEM_INV_FCST_WEEK_AGG TARGET
 USING (
    SELECT STG.LOCATION_ITEM_INV_FCST_WEEK_AGG_KEY as MERGE_KEY, STG.*
    FROM L2_STAGE.LOCATION_ITEM_INV_FCST_WEEK_AGG_STG STG
    UNION
    SELECT NULL as MERGE_KEY, STG1.*
    FROM L2_STAGE.LOCATION_ITEM_INV_FCST_WEEK_AGG_STG STG1
    ) STG2 
    ON TARGET.LOCATION_ITEM_INV_FCST_WEEK_AGG_KEY = STG2.MERGE_KEY
    WHEN MATCHED AND TARGET.LAST_EFFECTIVE_TS = '9999-12-31T23:59:59.000' 
    THEN
        UPDATE SET 
        TARGET.LAST_EFFECTIVE_TS = FROM_UNIXTIME(CAST(STG2.FIRST_EFFECTIVE_TS AS LONG) - 1),
        TARGET.UPDATE_TS = STG2.UPDATE_TS
    WHEN NOT MATCHED AND MERGE_KEY IS NULL 
    THEN
        INSERT (LOCATION_ITEM_INV_FCST_WEEK_AGG_KEY,
        LOCATION_ITEM_INV_FCST_WEEK_AGG_ID,
        CONCEPT_CD	,			 				
        LOCATION_KEY	,
        LOCATION_ID	,
        ITEM_KEY,		
        ITEM_ID,			
        ITEM_NAME,
        MARKET_CD,
        INV_FCST_ITEM_PLACEHOLDER_KEY,
        INV_FCST_ITEM_PLACEHOLDER_ID,	
        FISCAL_WEEK_KEY, 
        FISCAL_WEEK_NBR,
        FISCAL_WEEK_START_DT,
        FISCAL_WEEK_END_DT,			
        FIRST_EFFECTIVE_TS    ,
        LAST_EFFECTIVE_TS    ,
        PARENT_ITEM_PLACEHOLDER_CD,
        ITEM_PLACEHOLDER_DESC,
        ITEM_PLACEHOLDER_DEPT_DESC,
        PROJECTED_STOCK_ON_HAND_QTY	,		
        CONSTRAINED_DEMAND_UNITS_CNT	,
        EFFECTIVE_SAFETY_STOCK_UNITS_CNT	,
        LOST_SALES_UNITS_CNT	,
        MIN_SAFETY_STOCK_UNITS_CNT,
        MODEL_STOCK_UNITS_CNT,
        PRE_AUTHORIZED_ORDER_CNT,
        RECOMMENDED_ORDER_UNITS_CNT,
        EXPEDITE_UNITS_CNT,
        MAX_STOCK_DAYS_CNT,
        MAX_STOCK_UNITS_CNT,
        SHORT_FALL_UNITS_CNT,
        STOCK_OUT_UNITS_CNT,
        SURPLUS_UNITS_CNT,
        RESERVED_STOCK_UNITS_CNT,
        RECOMMENDED_SAFETY_STOCK_UNITS_CNT, 
        OPTIMAL_ALLOCATION_UNIT_CNT,
        DC_RESERVED_UNIT_CNT,
        ALLOCATED_IN_TRANSIT_UNIT_CNT,
        ALLOCATED_UNIT_CNT,
        PRE_ALLOCATED_UNIT_CNT,	 		 	
        INSERT_TS,			
        UPDATE_TS) 
        VALUES (STG2.LOCATION_ITEM_INV_FCST_WEEK_AGG_KEY,
        STG2.LOCATION_ITEM_INV_FCST_WEEK_AGG_ID,
        STG2.CONCEPT_CD	,			 				
        STG2.LOCATION_KEY	,
        STG2.LOCATION_ID	,
        STG2.ITEM_KEY,		
        STG2.ITEM_ID,			
        STG2.ITEM_NAME,
        STG2.MARKET_CD,
        STG2.INV_FCST_ITEM_PLACEHOLDER_KEY,
        STG2.INV_FCST_ITEM_PLACEHOLDER_ID,	
        STG2.FISCAL_WEEK_KEY, 
        STG2.FISCAL_WEEK_NBR,
        STG2.FISCAL_WEEK_START_DT,
        STG2.FISCAL_WEEK_END_DT,			
        STG2.FIRST_EFFECTIVE_TS    ,
        STG2.LAST_EFFECTIVE_TS    ,
        STG2.PARENT_ITEM_PLACEHOLDER_CD,
        STG2.ITEM_PLACEHOLDER_DESC,
        STG2.ITEM_PLACEHOLDER_DEPT_DESC,
        STG2.PROJECTED_STOCK_ON_HAND_QTY	,		
        STG2.CONSTRAINED_DEMAND_UNITS_CNT	,
        STG2.EFFECTIVE_SAFETY_STOCK_UNITS_CNT	,
        STG2.LOST_SALES_UNITS_CNT	,
        STG2.MIN_SAFETY_STOCK_UNITS_CNT,
        STG2.MODEL_STOCK_UNITS_CNT,
        STG2.PRE_AUTHORIZED_ORDER_CNT,
        STG2.RECOMMENDED_ORDER_UNITS_CNT,
        STG2.EXPEDITE_UNITS_CNT,
        STG2.MAX_STOCK_DAYS_CNT,
        STG2.MAX_STOCK_UNITS_CNT,
        STG2.SHORT_FALL_UNITS_CNT,
        STG2.STOCK_OUT_UNITS_CNT,
        STG2.SURPLUS_UNITS_CNT,
        STG2.RESERVED_STOCK_UNITS_CNT,
        STG2.RECOMMENDED_SAFETY_STOCK_UNITS_CNT, 
        STG2.OPTIMAL_ALLOCATION_UNIT_CNT,
        STG2.DC_RESERVED_UNIT_CNT,
        STG2.ALLOCATED_IN_TRANSIT_UNIT_CNT,
        STG2.ALLOCATED_UNIT_CNT,
        STG2.PRE_ALLOCATED_UNIT_CNT,	 	 	
        STG2.INSERT_TS,			
        STG2.UPDATE_TS);


        OPTIMIZE L2_ANALYTICS_TABLES.LOCATION_ITEM_INV_FCST_WEEK_AGG ZORDER BY LAST_EFFECTIVE_TS  ;