  /*
******************************************************************

** Author					: JUNAID
** Team                     : Godavari team (Supplychain_Godavari@wsgc.com)
** Create Date		: JULY, 2021
** Purpose      	: Merging NETSUITE TRANSACTIONS ORDER data from stage table into SnowFlake ORDER LINE table
******************************************************************
******************************************************************
************************* Change History *************************
******************************************************************

** Change   Date        Author                 Description
**  --      ----------  --------             --------------------------------
**  01      07/27/2021  JUNAID                  SQL file created
**  02      10/22/2021  Godavari                UFA deployment
**  03      02/02/2022  Godavari                21.27 Remapping
******************************************************************
*/

MERGE INTO "PROD_EDAP_ANALYTICS_DB"."PROD_EDAP_ANALYTICS_TABLES"."ORDER_LINE" TARGET
 USING (
    SELECT STG.ORDER_LINE_KEY as MERGE_KEY, STG.*
        FROM "PROD_EDAP_STAGE_DB"."PROD_EDAP_STAGE_TABLES"."NETSUITE_OL_SF_STG" STG
    UNION
    SELECT NULL as MERGE_KEY, STG1.*
        FROM "PROD_EDAP_STAGE_DB"."PROD_EDAP_STAGE_TABLES"."NETSUITE_OL_SF_STG" STG1) STG2 ON TARGET.ORDER_LINE_KEY = STG2.MERGE_KEY
    WHEN MATCHED AND TARGET.LAST_EFFECTIVE_TS = '9999-12-31T23:59:59.000' and TARGET.SOURCE_SYSTEM = 'GLOBAL_NETSUITE'  THEN
        UPDATE SET TARGET.LAST_EFFECTIVE_TS = dateadd(second,-1,STG2.FIRST_EFFECTIVE_TS), TARGET.UPDATE_TS = STG2.UPDATE_TS
    WHEN NOT MATCHED AND MERGE_KEY IS NULL THEN
    INSERT
    (ORDER_LINE_KEY,
    ORDER_LINE_ID,
    ORDER_HEADER_KEY,
    CHAINED_FROM_ORDER_HEADER_KEY,
    CHAINED_FROM_ORDER_HEADER_ID,
    CHAINED_FROM_ORDER_LINE_KEY,
    CHAINED_FROM_ORDER_LINE_ID,
    SOURCE_SYSTEM,
    ORDER_DT,
    ORDER_LINE_TYPE,
    PRIME_LINE_SEQ_NBR,
    SUB_LINE_SEQ_NBR,
    LINKED_ORDER_HEADER_KEY,
    LINKED_ORDER_HEADER_ID,
    LINKED_ORDER_LINE_KEY,
    LINKED_ORDER_LINE_ID,
    ITEM_KEY,
    ORDER_ITEM_ID,
    ORDER_ITEM_TYPE_CD,
    ORDER_ITEM_NAME,
	SELL_ITEM_KEY,
	SELL_ITEM_ID,
	ORIGINAL_ITEM_KEY,
	ORIGINAL_ITEM_ID,
	BUNDLE_ORDER_LINE_ITEM_KEY,
	BUNDLE_ORDER_LINE_ITEM_ID,
    GIFT_REGISTRY_KEY,
    GIFT_REGISTRY_ID,
    GLOBAL_SUBSIDIARY_KEY,
    GLOBAL_SUBSIDIARY_ID, 
    GLOBAL_COST_CENTER_KEY,
    GLOBAL_COST_CENTER_ID,
    GLOBAL_COST_CENTER_DESC,
    GLOBAL_FULFILLMENT_STATUS_KEY,
    GLOBAL_FULFILLMENT_STATUS_CD,
	IMPORT_DESC,
    PACK_ITEM_KEY,
    PACK_ITEM_ID,	
	MEDIA_KEY,
	MEDIA_ID,	
    FIRST_EFFECTIVE_TS,
    LAST_EFFECTIVE_TS,
    UPC_CD,
    KIT_CD,
    KIT_QTY,
    PRODUCT_LINE,
    BUNDLE_PARENT_ORDER_LINE_ID,
    ORDER_QTY,
    ORIG_ORDER_QTY,
    ACT_SALE_UNIT_PRICE_AMT,
    REG_SALE_UNIT_PRICE_AMT,
    EXTENDED_AMT,
    EXTENDED_DISCOUNT_AMT,
    TAX_AMT,
    TAXABLE_AMT,
    GIFT_CARD_AMT,
    GIFTWRAP_CHARGE_AMT,
    LINE_TOTAL_AMT,
    MERCHANDISE_CHARGE_AMT,
    MONO_PZ_CHARGE_AMT,
    MISC_CHARGE_AMT,
    SHIPPING_HANDLING_CHARGE_AMT,
    SHIPPING_SURCHARGE_AMT,
    DONATION_AMT,
	LINE_MERCH_DISC_AMT ,
    CNCLD_DEST_SURCHARGE_TAX_AMT  ,
    CNCLD_GIFT_WRAP_TAX_AMT ,
    CNCLD_LINE_DEST_SURCHARGE_EFF_AMT,
    CNCLD_LINE_GIFT_WRAP_EFF_AMT,
    CNCLD_LINE_MERCH_EFF_AMT,
    CNCLD_LINE_MONO_PZ_EFF_AMT,
    CNCLD_LINE_SHIPPING_EFF_AMT,
    CNCLD_LINE_SURCHARGE_EFF_AMT,
    CNCLD_LINE_MERCH_TAX_AMT,
    CNCLD_LINE_MONO_PZ_TAX_AMT,
    CNCLD_SHIPPING_TAX_AMT,
    CNCLD_SURCHARGE_TAX_AMT,
    DEST_SURCHARGE_TAX_AMT,
    GIFT_WRAP_TAX_AMT,
    LINE_DEST_SURCHARGE_EFF_AMT,
    LINE_SURCHARGE_EFF_AMT,
    MERCH_TAX_AMT,
    MONO_PZ_TAX_AMT,
    SHIPPING_TAX_AMT,
    SURCHARGE_TAX_AMT,
    ASSOCIATE_ID,
    ENTRY_METHOD,
    GIFT_MESSAGE,
    VOID_FLAG,
    REPO_FLAG,
    TAXABLE_FLAG,
    PICKABLE_FLAG,
    GIFT_FLAG,
    FREE_SWATCH_FLAG,
    HOLD_FLAG,
    HOLD_REASON,
    ORIG_BACKORDER_FLAG,
    SUBORDER_COMPLEXITY_GROUP_ID,
    DELIVERY_CHOICE,
    MODIFICATION_REASON_CD,
    MODIFICATION_REASON_CD_DESC,
    RETURN_ACTION_CD,
    RETURN_ACTION,
    RETURN_REASON_CD,
    RETURN_REASON_DESC,
    RETURN_SUB_REASON_CD,
    SHIP_TO_FIRST_NAME,
    SHIP_TO_MIDDLE_NAME,
    SHIP_TO_LAST_NAME,
    SHIP_TO_ADDRESS_LINE_1,
    SHIP_TO_ADDRESS_LINE_2,
    SHIP_TO_CITY,
    SHIP_TO_STATE_OR_PROV,
    SHIP_TO_POSTAL_CD,
    SHIP_TO_COUNTRY,
    SHIP_TO_EMAIL_ADDRESS,
    SHIP_TO_PHONE_NBR,
	CUSTOMER_ORDER_NBR,
    DELIVERY_METHOD,
    FULFILLMENT_TYPE,
    DTC_SUBORDER_NBR,
    ADDITIONAL_LINE_TYPE_CD,
    ORIG_CONFIRMED_QTY,
    RESKU_FLAG,
    CONSOLIDATOR_ADDRESS_CD,
    MERGE_NODE_CD,
    SHIP_NODE_CD,
    RECEIVING_NODE_CD,
    LEVEL_OF_SERVICE,
    CARRIER_SERVICE_CD,
    CARRIER_CD,
	VENDOR_PACK_SIZE,
	HTS_CD,
	INNER_PACK_SIZE,
    ACCESS_POINT_CD,
    ACCESS_POINT_ID,
    ACCESS_POINT_NM,
    MINIMUM_SHIP_DT,
    REQUESTED_SHIP_DT,
    REQUESTED_DELIVERY_DT,
    EARLIEST_SCHEDULE_DT,
    EARLIEST_DELIVERY_DT,
    PROMISED_APPT_END_DT,
    GLOBAL_PO_CLOSED_DT,
    CHANGED_DAYS_CNT,
    SPLIT_QTY,
    SHIPPED_QTY,
    FILL_QTY,
    WEIGHTED_AVG_COST,
    DIRECT_SHIP_FLAG,
    UNIT_COST,
    LABOR_COST,
    LABOR_SKU,
    CUSTOMER_LEVEL_OF_SERVICE,
    RETURN_POLICY,
    RETURN_POLICY_CHECK_OVERRIDE_FLAG,
	RETURN_POLICY_ERROR,
    PRODUCT_AVAILABILITY_DT,
    ECDD_OVERRIDDEN_FLAG,
    ECDD_INVOKED_FLAG,
    VAS_GIFT_WRAP_CD,
    VAS_MONO_FLAG,
    VAS_PZ_FLAG,
	VAS_RECIPE_FLAG,
	VAS_CARE_CARD_FLAG,
    BO_NOTIFICATION_NBR,
    BO_NOTIFICATION_TYPE_CD,
	SOURCE_CREATE_TS,
    INSERT_TS,
    UPDATE_TS)
    VALUES
    (STG2.ORDER_LINE_KEY,
    STG2.ORDER_LINE_ID,
    STG2.ORDER_HEADER_KEY,
    STG2.CHAINED_FROM_ORDER_HEADER_KEY,
    STG2.CHAINED_FROM_ORDER_HEADER_ID,
    STG2.CHAINED_FROM_ORDER_LINE_KEY,
    STG2.CHAINED_FROM_ORDER_LINE_ID,
    STG2.SOURCE_SYSTEM,
    STG2.ORDER_DT,
    STG2.ORDER_LINE_TYPE,
    STG2.PRIME_LINE_SEQ_NBR,
    STG2.SUB_LINE_SEQ_NBR,
    STG2.LINKED_ORDER_HEADER_KEY,
    STG2.LINKED_ORDER_HEADER_ID,
    STG2.LINKED_ORDER_LINE_KEY,
    STG2.LINKED_ORDER_LINE_ID,
    STG2.ITEM_KEY,
    STG2.ORDER_ITEM_ID,
    STG2.ORDER_ITEM_TYPE_CD,
    STG2.ORDER_ITEM_NAME,
	STG2.SELL_ITEM_KEY,
	STG2.SELL_ITEM_ID,
	STG2.ORIGINAL_ITEM_KEY,
	STG2.ORIGINAL_ITEM_ID,
	STG2.BUNDLE_ORDER_LINE_ITEM_KEY,
	STG2.BUNDLE_ORDER_LINE_ITEM_ID,
    STG2.GIFT_REGISTRY_KEY,
    STG2.GIFT_REGISTRY_ID,
    STG2.GLOBAL_SUBSIDIARY_KEY,
    STG2.GLOBAL_SUBSIDIARY_ID, 
    STG2.GLOBAL_COST_CENTER_KEY,
    STG2.GLOBAL_COST_CENTER_ID,
    STG2.GLOBAL_COST_CENTER_DESC,
    STG2.GLOBAL_FULFILLMENT_STATUS_KEY,
    STG2.GLOBAL_FULFILLMENT_STATUS_CD,
	STG2.IMPORT_DESC,
    STG2.PACK_ITEM_KEY,
    STG2.PACK_ITEM_ID,	
	STG2.MEDIA_KEY,
	STG2.MEDIA_ID,
    STG2.FIRST_EFFECTIVE_TS,
    STG2.LAST_EFFECTIVE_TS,
    STG2.UPC_CD,
    STG2.KIT_CD,
    STG2.KIT_QTY,
    STG2.PRODUCT_LINE,
    STG2.BUNDLE_PARENT_ORDER_LINE_ID,
    STG2.ORDER_QTY,
    STG2.ORIG_ORDER_QTY,
    STG2.ACT_SALE_UNIT_PRICE_AMT,
    STG2.REG_SALE_UNIT_PRICE_AMT,
    STG2.EXTENDED_AMT,
    STG2.EXTENDED_DISCOUNT_AMT,
    STG2.TAX_AMT,
    STG2.TAXABLE_AMT,
    STG2.GIFT_CARD_AMT,
    STG2.GIFTWRAP_CHARGE_AMT,
    STG2.LINE_TOTAL_AMT,
    STG2.MERCHANDISE_CHARGE_AMT,
    STG2.MONO_PZ_CHARGE_AMT,
    STG2.MISC_CHARGE_AMT,
    STG2.SHIPPING_HANDLING_CHARGE_AMT,
    STG2.SHIPPING_SURCHARGE_AMT,
    STG2.DONATION_AMT,
	STG2.LINE_MERCH_DISC_AMT ,
    STG2.CNCLD_DEST_SURCHARGE_TAX_AMT  ,
    STG2.CNCLD_GIFT_WRAP_TAX_AMT ,
    STG2.CNCLD_LINE_DEST_SURCHARGE_EFF_AMT,
    STG2.CNCLD_LINE_GIFT_WRAP_EFF_AMT,
    STG2.CNCLD_LINE_MERCH_EFF_AMT,
    STG2.CNCLD_LINE_MONO_PZ_EFF_AMT,
    STG2.CNCLD_LINE_SHIPPING_EFF_AMT,
    STG2.CNCLD_LINE_SURCHARGE_EFF_AMT,
    STG2.CNCLD_LINE_MERCH_TAX_AMT,
    STG2.CNCLD_LINE_MONO_PZ_TAX_AMT,
    STG2.CNCLD_SHIPPING_TAX_AMT,
    STG2.CNCLD_SURCHARGE_TAX_AMT,
    STG2.DEST_SURCHARGE_TAX_AMT,
    STG2.GIFT_WRAP_TAX_AMT,
    STG2.LINE_DEST_SURCHARGE_EFF_AMT,
    STG2.LINE_SURCHARGE_EFF_AMT,
    STG2.MERCH_TAX_AMT,
    STG2.MONO_PZ_TAX_AMT,
    STG2.SHIPPING_TAX_AMT,
    STG2.SURCHARGE_TAX_AMT,
    STG2.ASSOCIATE_ID,
    STG2.ENTRY_METHOD,
    STG2.GIFT_MESSAGE,
    STG2.VOID_FLAG,
    STG2.REPO_FLAG,
    STG2.TAXABLE_FLAG,
    STG2.PICKABLE_FLAG,
    STG2.GIFT_FLAG,
    STG2.FREE_SWATCH_FLAG,
    STG2.HOLD_FLAG,
    STG2.HOLD_REASON,
    STG2.ORIG_BACKORDER_FLAG,
    STG2.SUBORDER_COMPLEXITY_GROUP_ID,
    STG2.DELIVERY_CHOICE,
    STG2.MODIFICATION_REASON_CD,
    STG2.MODIFICATION_REASON_CD_DESC,
    STG2.RETURN_ACTION_CD,
    STG2.RETURN_ACTION,
    STG2.RETURN_REASON_CD,
    STG2.RETURN_REASON_DESC,
    STG2.RETURN_SUB_REASON_CD,
    STG2.SHIP_TO_FIRST_NAME,
    STG2.SHIP_TO_MIDDLE_NAME,
    STG2.SHIP_TO_LAST_NAME,
    STG2.SHIP_TO_ADDRESS_LINE_1,
    STG2.SHIP_TO_ADDRESS_LINE_2,
    STG2.SHIP_TO_CITY,
    STG2.SHIP_TO_STATE_OR_PROV,
    STG2.SHIP_TO_POSTAL_CD,
    STG2.SHIP_TO_COUNTRY,
    STG2.SHIP_TO_EMAIL_ADDRESS,
    STG2.SHIP_TO_PHONE_NBR,
	STG2.CUSTOMER_ORDER_NBR,
    STG2.DELIVERY_METHOD,
    STG2.FULFILLMENT_TYPE,
    STG2.DTC_SUBORDER_NBR,
    STG2.ADDITIONAL_LINE_TYPE_CD,
    STG2.ORIG_CONFIRMED_QTY,
    STG2.RESKU_FLAG,
    STG2.CONSOLIDATOR_ADDRESS_CD,
    STG2.MERGE_NODE_CD,
    STG2.SHIP_NODE_CD,
    STG2.RECEIVING_NODE_CD,
    STG2.LEVEL_OF_SERVICE,
    STG2.CARRIER_SERVICE_CD,
    STG2.CARRIER_CD,
	STG2.VENDOR_PACK_SIZE,
	STG2.HTS_CD,
	STG2.INNER_PACK_SIZE,
    STG2.ACCESS_POINT_CD,
    STG2.ACCESS_POINT_ID,
    STG2.ACCESS_POINT_NM,
    STG2.MINIMUM_SHIP_DT,
    STG2.REQUESTED_SHIP_DT,
    STG2.REQUESTED_DELIVERY_DT,
    STG2.EARLIEST_SCHEDULE_DT,
    STG2.EARLIEST_DELIVERY_DT,
    STG2.PROMISED_APPT_END_DT,
    STG2.GLOBAL_PO_CLOSED_DT,
    STG2.CHANGED_DAYS_CNT,
    STG2.SPLIT_QTY,
    STG2.SHIPPED_QTY,
    STG2.FILL_QTY,
    STG2.WEIGHTED_AVG_COST,
    STG2.DIRECT_SHIP_FLAG,
    STG2.UNIT_COST,
    STG2.LABOR_COST,
    STG2.LABOR_SKU,
    STG2.CUSTOMER_LEVEL_OF_SERVICE,
    STG2.RETURN_POLICY,
    STG2.RETURN_POLICY_CHECK_OVERRIDE_FLAG,
	STG2.RETURN_POLICY_ERROR,
    STG2.PRODUCT_AVAILABILITY_DT,
    STG2.ECDD_OVERRIDDEN_FLAG,
    STG2.ECDD_INVOKED_FLAG,
    STG2.VAS_GIFT_WRAP_CD,
    STG2.VAS_MONO_FLAG,
    STG2.VAS_PZ_FLAG,
	STG2.VAS_RECIPE_FLAG,
	STG2.VAS_CARE_CARD_FLAG,
    STG2.BO_NOTIFICATION_NBR,
    STG2.BO_NOTIFICATION_TYPE_CD,
	STG2.SOURCE_CREATE_TS,
    STG2.INSERT_TS,
    STG2.UPDATE_TS);

TRUNCATE TABLE "PROD_EDAP_STAGE_DB"."PROD_EDAP_STAGE_TABLES"."NETSUITE_OL_SF_STG";