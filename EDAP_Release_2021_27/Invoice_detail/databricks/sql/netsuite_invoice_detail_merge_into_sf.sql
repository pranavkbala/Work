MERGE INTO "PROD_EDAP_ANALYTICS_DB"."PROD_EDAP_ANALYTICS_TABLES"."INVOICE_DETAIL" TARGET
 USING (
    SELECT STG.INVOICE_DETAIL_KEY as MERGE_KEY, STG.*
        FROM "PROD_EDAP_STAGE_DB"."PROD_EDAP_STAGE_TABLES"."NETSUITE_INVOICE_DETAIL_STG" STG
    UNION
    SELECT NULL as MERGE_KEY, STG1.*
        FROM "PROD_EDAP_STAGE_DB"."PROD_EDAP_STAGE_TABLES"."NETSUITE_INVOICE_DETAIL_STG" STG1) STG2 ON TARGET.INVOICE_DETAIL_KEY = STG2.MERGE_KEY
    WHEN MATCHED AND TARGET.LAST_EFFECTIVE_TS = '9999-12-31T23:59:59.000' THEN
        UPDATE SET TARGET.LAST_EFFECTIVE_TS = dateadd(second,-1,STG2.FIRST_EFFECTIVE_TS), TARGET.UPDATE_TS = STG2.UPDATE_TS
    WHEN NOT MATCHED AND MERGE_KEY IS NULL THEN
        INSERT (
                INVOICE_DETAIL_KEY,  
                INVOICE_DETAIL_ID,
                CONCEPT_CD,
                SOURCE_SYSTEM,
                PRIME_LINE_SEQ_NBR,
                INVOICE_KEY,
                INVOICE_ID,
                INVOICE_DT,
                ITEM_KEY,
                ITEM_ID,
                ORDER_LINE_KEY,
                ORDER_LINE_ID,
                LOCATION_KEY,
                LOCATION_ID,
                GLOBAL_COST_CENTER_KEY,
                GLOBAL_COST_CENTER_ID,
                GLOBAL_SUBSIDIARY_KEY,
                GLOBAL_SUBSIDIARY_ID,
                FIRST_EFFECTIVE_TS,
                LAST_EFFECTIVE_TS,
                RETAIL_TYPE_CD,
                POS_RING_TYPE_CD,
                TXN_TYPE_CD,
                TXN_SUB_TYPE_CD,
                ENTRY_METHOD,
                SLSPRSN_ID,
                INVOICE_QTY,
                INVOICE_AMT,
                UNIT_PRICE_AMT,
                GLOBAL_ESTIMATED_COST_AMT,
                TXN_SIGN,
                TAXABLE_FLAG,                
                ORIG_TXN_NBR,
                ORIG_UNIT_PRICE_AMT,
                ORIG_TXN_SIGN_CD,
                REASON_ID,
                RETURN_REASON_ID,
                DROP_SHIP_FLAG,
                ACTUAL_SHIP_DT,
                WEIGHTED_AVG_COST,
                LABOR_COST,
                LABOR_SKU,
                VENDOR_COST,
                PO_EXPENSES,
                PO_DUTY,
                FULFILLMENT_STATUS_ID,
                DISCOUNT_RATE_AMT,
                ELC_AGENT_COMMISSION_AMT,
                ELC_HTS_AMT,
                ELC_FREIGHT_AMT,
                ELC_MISC_AMT,
                FIRST_COST_AMT,
                PACK_GROUP_NBR,
                COMMITTED_QTY,
                CLOSED_DT,
                INSERT_TS,
                UPDATE_TS     
            )
        VALUES (         
                STG2.INVOICE_DETAIL_KEY,  
                STG2.INVOICE_DETAIL_ID,
                STG2.CONCEPT_CD,
                STG2.SOURCE_SYSTEM,
                STG2.PRIME_LINE_SEQ_NBR,
                STG2.INVOICE_KEY,
                STG2.INVOICE_ID,
                STG2.INVOICE_DT,
                STG2.ITEM_KEY,
                STG2.ITEM_ID,
                STG2.ORDER_LINE_KEY,
                STG2.ORDER_LINE_ID,
                STG2.LOCATION_KEY,
                STG2.LOCATION_ID,
                STG2.GLOBAL_COST_CENTER_KEY,
                STG2.GLOBAL_COST_CENTER_ID,
                STG2.GLOBAL_SUBSIDIARY_KEY,
                STG2.GLOBAL_SUBSIDIARY_ID,
                STG2.FIRST_EFFECTIVE_TS,
                STG2.LAST_EFFECTIVE_TS,
                STG2.RETAIL_TYPE_CD,
                STG2.POS_RING_TYPE_CD,
                STG2.TXN_TYPE_CD,
                STG2.TXN_SUB_TYPE_CD,
                STG2.ENTRY_METHOD,
                STG2.SLSPRSN_ID,
                STG2.INVOICE_QTY,
                STG2.INVOICE_AMT,
                STG2.UNIT_PRICE_AMT,
                STG2.GLOBAL_ESTIMATED_COST_AMT,
                STG2.TXN_SIGN,
                STG2.TAXABLE_FLAG,                
                STG2.ORIG_TXN_NBR,
                STG2.ORIG_UNIT_PRICE_AMT,
                STG2.ORIG_TXN_SIGN_CD,
                STG2.REASON_ID,
                STG2.RETURN_REASON_ID,
                STG2.DROP_SHIP_FLAG,
                STG2.ACTUAL_SHIP_DT,
                STG2.WEIGHTED_AVG_COST,
                STG2.LABOR_COST,
                STG2.LABOR_SKU,
                STG2.VENDOR_COST,
                STG2.PO_EXPENSES,
                STG2.PO_DUTY,
                STG2.FULFILLMENT_STATUS_ID,
                STG2.DISCOUNT_RATE_AMT,
                STG2.ELC_AGENT_COMMISSION_AMT,
                STG2.ELC_HTS_AMT,
                STG2.ELC_FREIGHT_AMT,
                STG2.ELC_MISC_AMT,
                STG2.FIRST_COST_AMT,
                STG2.PACK_GROUP_NBR,
                STG2.COMMITTED_QTY,
                STG2.CLOSED_DT,
                STG2.INSERT_TS,
                STG2.UPDATE_TS
         )